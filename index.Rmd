---
title: "CM"
author: "Bente Klein Hazebroek"
output: 
    flexdashboard::flex_dashboard:
      storyboard: true
      orientation: rows
      vertical_layout: scroll
      theme: lumen
---

```{r}
library(tidyverse)
library(tidymodels)
library(spotifyr)
library(flexdashboard)
library(plotly)
library(Cairo)
library(shiny)
library(plyr)
library(ggplot2)
library(dplyr)
library(knitr)
library(kknn)
library(randomForest)
library(compmus)
library(ggdendro)
library(protoclust)
library(heatmaply)
Sys.setenv(SPOTIFY_CLIENT_ID = '7695c57a82654e18ae7990e714b60c38')
Sys.setenv(SPOTIFY_CLIENT_SECRET = 'fac65dcc16154cbeb79e71ef5dbd9465')
load("~/CLC jaar 2/Computational Musicology/BKH/TOTALCOFFEEHOUSE.RData")
load("~/CLC jaar 2/Computational Musicology/BKH/TOTALONTHEROAD.RData")
BOTHPLAYLISTS <- rbind(TOTALCOFFEEHOUSE, TOTALONTHEROAD)
```

Corpus {.tabset}
=================================================================

Introduction {.sidebar}
----------------------------------------------------------------

### Coffee - Road

I am looking at Spotify's *'Coffeehouse'* and *'On the Road'* playlists. A coffeehouse is a pleasant place where you can talk, work or read while enjoying a cup of coffee; you will probably listen to easy, mellow songs here. But, when you're on the road, you have to kill time while going from A to B - whether you're alone or with friends; you go to work or are on a holiday. Since the car is a private place, you might listen to familiar, sing-along songs. These settings give a completely different vibe, so my goal is to see whether Coffeehouse and On the Road playlists have characteristic features, and in what ways they differ.

Three popular Coffeehouse and On the Road playlists were selected, resulting in 280 Coffeehouse and 168 On the Road songs. The distribution of keys and mode can be seen in the plots - the lower part represents minor songs; the top major.

Playlists
---------------------------------------------------------------

### Playlists

I am using the following playlists for this research, composed by Spotify and Digster Nederland:

  **Coffeehouse:**
  
    1. Coffeehouse - Feel the vibe of the Coffeehouse playlist, full of relaxing singer-songwriter an pop music.    
    2. 't Koffiehuis - 'n Bakkie en gemoedelijke muziek op de achtergrond.    
    3. Your Favorite Coffeehouse - Curl up in your favorite spot with some sweet, mellow tunes...
  
 **On the Road:**
 
    1. Classic Road Trip Songs - The ultimate playlist to fuel your good mood while on the road.
    2. Onderweg - Met deze playlist heb je altijd de beste hits bij de hand voor onderweg.
    3. Road Trip - Go on a weekend getaway with your barkada and your favorite hits!

Keys Coffeehouse {data-height = 250}
----------------------------------------------------------------

```{r, echo=FALSE}
KeysInCoffee <- ggplot(TOTALCOFFEEHOUSE, aes(x = factor(key), fill = key, col = mode)) + geom_bar(aes(y = (..count..)/sum(..count..))) + scale_y_continuous(labels = scales::percent, limits = c(0, 0.2)) + theme(legend.position = "none") + ggtitle("Distribution of keys in Coffeehouse playlists") + xlab("") + ylab("") + scale_color_brewer("black")

KeysInRoad <- ggplot(TOTALONTHEROAD, aes(x = factor(key), fill = key, col = mode)) + geom_bar(aes(y = (..count..)/sum(..count..))) + scale_y_continuous(labels = scales::percent, limits = c(0, 0.2)) + theme(legend.position = "none") + ggtitle("Distribution of keys in On the Road playlists") + xlab("") + ylab("") + scale_color_brewer("black")
```

### Keys Coffeehouse

```{r}
ggplotly(KeysInCoffee)
```

Keys On the Road {height = 200}
----------------------------------------------------------------

### Keys On the Road

```{r}
ggplotly(KeysInRoad)
```
    
Findings {.tabset}
=================================================================

Text
-----------------------------------------------------------------
### Track popularity

The Coffeehouse playlists have a mean track popularity of 52.38 (SD = 25.751), whereas the On the Road playlists have a higher mean track popularity of 61.68 (SD = 29.766). This makes sense, since the On the Road playlists contain more songs that everyone can sing along to, and are thus familiar to a large audience. 

### Energy
I expect that energy of the On the Road playlists is much higher than for Coffehouse playlists. While on the road, you need to stay awake, so most songs have a loud beat. Coffeehouse songs, on the other hand, sound more quiet and peaceful. Spotify measured that the average energy in On the Road songs is 0.6131 (SD = 0.295) and 0.3596 (SD = 0.262) in Coffehouse songs. Indeed, energy seems to be much higher in On the Road playlists. 

### Acousticness

Characteristic for mellow Coffeehouse songs is their high acousticness (0.6589, SD = 0.347). The playlists contain mostly easy, soft songs that are accompanied by piano or guitar without much of electronic sounds. The acousticness of these playlists is thus, as expected, much higher than for On the Road playlists (0.2932, SD = 0.353). 

### Valence

I experience the On the Road playlists to be happier than Coffeehouse playlists, since these songs sound more uplifting to me. Spotify has generated a measure for valence: the higher the valence value, the happier the song. According to this measure, On the Road playlists are happier (0.4709, SD = 0.304) than Coffeehouse playlists (0.3555, SD = 0.3165).

Boxplots
----------------------------------------------------------------

```{r}
BoxplotTrackPopularity <- ggplot(BOTHPLAYLISTS, aes(x = playlist_name, y = track_popularity, fill = playlist_name)) + geom_boxplot() + scale_fill_manual(values = c("lightskyblue3", "palevioletred")) + theme(legend.position = "none", axis.title.x=element_blank(), axis.title.y = element_blank()) + ggtitle("Track Popularity")
```

```{r}
ggplotly(BoxplotTrackPopularity, echo = FALSE, width = 312.5)
```

```{r}
BoxplotEnergy <- ggplot(BOTHPLAYLISTS, aes(x = playlist_name, y = energy, fill = playlist_name)) + geom_boxplot() + scale_fill_manual(values = c("lightskyblue3", "palevioletred")) + theme(legend.position = "none", axis.title.x=element_blank(), axis.title.y = element_blank()) + ggtitle("Energy")
```

```{r}
ggplotly(BoxplotEnergy, echo = FALSE, width = 312.5)
```

```{r}
BoxplotAcousticness <- ggplot(BOTHPLAYLISTS, aes(x = playlist_name, y = acousticness, fill = playlist_name)) + geom_boxplot() + scale_fill_manual(values = c("lightskyblue3", "palevioletred")) + theme(legend.position = "none", axis.title.x=element_blank(), axis.title.y = element_blank()) + ggtitle("Acousticness")
```

```{r}
ggplotly(BoxplotAcousticness, echo = FALSE, width = 312.5)
```

```{r}
BoxplotValence <- ggplot(BOTHPLAYLISTS, aes(x = playlist_name, y = valence, fill = playlist_name)) + geom_boxplot() + scale_fill_manual(values = c("lightskyblue3", "palevioletred")) + theme(legend.position = "none", axis.title.x=element_blank(), axis.title.y = element_blank()) + ggtitle("Valence")
```

```{r}
ggplotly(BoxplotValence, echo = FALSE, width = 312.5)
```

All-in-one {.tabset}
=================================================================

----------------------------------------------
So, high *acousticness* is characteristic for Coffeehouse songs, whereas high *energy* is characteristic for Road Trip songs. Valence is higher in Coffeehouse playlists, and track popularity is higher in On the Road playlists. These four values are visualised in one plot to see a clear difference. Most of the Coffeehouse songs are in the left upper corner and On the Road songs are in the right lower corner. This figure indeed shows mostly high acoustiness and low energy in Coffeehouse, and high energy and low acousticness in On the Road. Songs with high energy and low acoustiness are happiest, but track popularity is not really clear. 

-----------------------------------------------
```{r}
plot_both_acousticenergy <-  ggplot(BOTHPLAYLISTS, aes(x = energy, y = acousticness, col = playlist_name, alpha = track_popularity, size = valence)) + geom_point() + scale_color_manual(values = c("lightskyblue3", "palevioletred"))
```

```{r, echo=FALSE}
ggplotly(plot_both_acousticenergy, height = 375)
```

Chromagrams {.tabset}
=================================================================

Row
-----------------------------------------------------------------
### Waiting Around

```{r}
WaitingAround <- 
    get_tidy_audio_analysis('6WQlGuh6c4jciXEyM2rVGX') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
```

```{r, echo = FALSE}
WaitingAround %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'chebyshev')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()
```

### Walk of Life

```{r}
WalkOfLife <- 
    get_tidy_audio_analysis('4xxB8QUtn8rF4Z2yaRICqp') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
```

```{r, echo = FALSE}
WalkOfLife %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'chebyshev')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()
```

Sidebar {.sidebar}
-----------------------------------------------------------------

### Chromagrams

I created a chromagram for Waiting Around (Aisha Badru), found in a Coffeehouse playlist, and Walk of Life (Dire Strates), found in an On the Road playlist.

Waiting Around is the song with highest acousticness (0.988), and low energy (0.1470). It is thus a good example of a Coffeehouse song. According to Spotify's API, it is in F major. F-A-C is indeed found in the chromagram, although it might as well be in C major.

On the other hand, Walk of Life is a typical On the Road song: it is the song with most energy (0.960) and has low acousticness (0.356). Spotify says it should be in E major, and indeed the chromagram seems to show mostly E and B - this makes sense for E major. However, a wide range of pitch classes can be seen. 

Cepstrograms {.tabset}
==================================================================

Row
-----------------------------------------------------------------

```{r}
Firestone <- 
    get_tidy_audio_analysis('4gek9UL5WceAq1qiZlhmGM') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))
```

```{r}
AppMe <- 
    get_tidy_audio_analysis('012VxxpXwn4quWIN4F8jiQ') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))
```

### Firestone
```{r}
Firestone %>% 
    compmus_gather_timbre %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = basis, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    scale_fill_viridis_c(option = 'E') +
    theme_classic()
```

### App Me
```{r}
AppMe %>% 
    compmus_gather_timbre %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = basis, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    scale_fill_viridis_c(option = 'E') +
    theme_classic()
```

Sidebar {.sidebar}
-----------------------------------------------------------------

### Cepstrograms

The mean loudness of Coffeehouse songs is -10.845Hz, and -7.4239Hz for On the Road songs. I chose the songs that are closest to these averages to create cepstrograms. This is Firestone - Live Acoustic (Kygo & Conrad Sewell) for Coffeehouse with -10.831Hz and App Me (Lucky Fonz III) for On the Road, with -7.440Hz.

Self-Similarity Matrixes {.tabset}
=================================================================

Row
-----------------------------------------------------------------

```{r}
LeaveALightOn <- 
    get_tidy_audio_analysis('2k2CZ1dJClLmDO2TVGsz1R') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))
```

```{r}
PianoMan <- 
    get_tidy_audio_analysis('70C4NyhjD5OZUMzvWZ3njJ') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))
```

### Leave a Light On 
```{r}
LeaveALightOn %>% 
    compmus_self_similarity(timbre, 'cosine') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
```

### Piano Man
```{r}
PianoMan %>% 
    compmus_self_similarity(timbre, 'cosine') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
```

Sidebar {.sidebar}
-----------------------------------------------------------------

### Self-Similarity Matrixes

I have listened to a few random songs in both playlists, and thought Leave a Light On - Acoustic (Tom Walker) and Piano Man (Billy Joel) would be interesting to see in a Self-Similarity Matrix. Both songs seem to have repeating patterns throughout the whole song.


Random Forest classification
==================================================================

```{r}
Coffeehouse6 <- 
    get_playlist_audio_features('kleinhazebroek', '6FOK30Tkpnsuv0fVFGXhai') %>% 
       add_audio_analysis

Ontheroad6 <- 
    get_playlist_audio_features('kleinhazebroek', '4UhUpq66QpV5bn9GicW406') %>% 
       add_audio_analysis

PianoMan2 <- 
    get_tidy_audio_analysis('70C4NyhjD5OZUMzvWZ3njJ') %>% 
    select(segments) %>% unnest(segments)
```

```{r}
Bothplaylists6 <- 
    Coffeehouse6 %>% mutate(playlist = "COFFEEHOUSE") %>% 
    bind_rows(
        Ontheroad6 %>% mutate(playlist = "ONTHEROAD")) %>% 
    mutate(playlist = factor(playlist)) %>% 
    mutate(
        segments = 
            map2(segments, key, compmus_c_transpose)) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'),
        timbre =
            map(
                segments,
                compmus_summarise, timbre,
                method = 'mean')) %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'clr')) %>% 
    mutate_at(vars(pitches, timbre), map, bind_rows) %>% 
    unnest(pitches, timbre)
```

```{r}
Bothplaylists_class <- 
    recipe(playlist ~
               danceability +
               energy +
               loudness +
               speechiness +
               acousticness +
               instrumentalness +
               liveness +
               valence +
               tempo +
               duration_ms +
               C + `C#|Db` + D + `D#|Eb` +
               E + `F` + `F#|Gb` + G +
               `G#|Ab` + A + `A#|Bb` + B +
               c01 + c02 + c03 + c04 + c05 + c06 +
               c07 + c08 + c09 + c10 + c11 + c12,
           data = Bothplaylists6) %>% 
    step_center(all_predictors()) %>%
    step_scale(all_predictors()) %>%
    # step_range(all_predictors()) %>% 
    prep(Bothplaylists6) %>% 
    juice
```

```{r}
Bothplaylists_cv <- Bothplaylists_class %>% vfold_cv(10)
```

```{r}
Bothplaylists_knn <- nearest_neighbor(neighbors = 1) %>% set_engine('kknn')
predict_knn <- function(split)
    fit(Bothplaylists_knn, playlist ~ ., data = analysis(split)) %>% 
    predict(assessment(split), type = 'class') %>%
    bind_cols(assessment(split))
```

```{r}
Bothplaylists_forest <- rand_forest() %>% set_engine('randomForest')
predict_forest <- function(split)
    fit(Bothplaylists_forest, playlist ~ ., data = analysis(split)) %>% 
    predict(assessment(split), type = 'class') %>%
    bind_cols(assessment(split))
```

```{r eval = FALSE}
Bothplaylists_cv %>% 
    mutate(pred = map(splits, predict_forest)) %>% 
    unnest(pred) %>% 
    metric_set(accuracy, kap, j_index)(truth = playlist, estimate = .pred_class)
```

Figures
------------------------------------------------

### Features
```{r}
Bothplaylists_class %>% 
    fit(Bothplaylists_forest, playlist ~ ., data = .) %>% 
    pluck('fit') %>% 
    randomForest::varImpPlot()
```

### Classification
```{r}
Bothplaylists_cv %>% 
    mutate(pred = map(splits, predict_forest)) %>% unnest(pred) %>% 
    conf_mat(truth = playlist, estimate = .pred_class) %>% 
    autoplot(type = 'heatmap')
```

Sidebar {.sidebar}
--------------------------------------------------

### Random Forest

A Random Forest Classification predicts whether random songs are from a Coffeehouse or On the Road playlist, with an accuracy of approximately 80%. The top features energy, acousticness and timbre features c01, c02 and c04 seem to be the most important when making this prediction.

Dendrograms {.tabset}
============================================================

Row 
-------------------------------------------
```{r}
Coffeehouse12 <- 
    get_playlist_audio_features('kleinhazebroek', '6FOK30Tkpnsuv0fVFGXhai') %>% 
    add_audio_analysis %>% 
    mutate(
        segments = 
            map2(segments, key, compmus_c_transpose)) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'),
        timbre =
            map(
                segments,
                compmus_summarise, timbre,
                method = 'mean')) %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'clr')) %>% 
    mutate_at(vars(pitches, timbre), map, bind_rows) %>% 
    unnest(pitches, timbre)
```

```{r}
OntheRoad12 <- 
    get_playlist_audio_features('kleinhazebroek', '4UhUpq66QpV5bn9GicW406') %>% 
    add_audio_analysis %>% 
    mutate(
        segments = 
            map2(segments, key, compmus_c_transpose)) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'),
        timbre =
            map(
                segments,
                compmus_summarise, timbre,
                method = 'mean')) %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'clr')) %>% 
    mutate_at(vars(pitches, timbre), map, bind_rows) %>% 
    unnest(pitches, timbre)
```

```{r}
Coffeehouse_juice <- 
    recipe(track_name ~
               danceability +
               energy +
               loudness +
               speechiness +
               acousticness +
               instrumentalness +
               liveness +
               valence +
               tempo +
               duration_ms +
               C + `C#|Db` + D + `D#|Eb` +
               E + `F` + `F#|Gb` + G +
               `G#|Ab` + A + `A#|Bb` + B +
               c01 + c02 + c03 + c04 + c05 + c06 +
               c07 + c08 + c09 + c10 + c11 + c12,
           data = Coffeehouse12) %>% 
    step_center(all_predictors()) %>%
    step_scale(all_predictors()) %>%
    # step_range(all_predictors()) %>% 
    prep(Coffeehouse12 %>% mutate(track_name = str_trunc(track_name, 20))) %>% 
    juice %>% 
    column_to_rownames('track_name')
```

```{r}
Ontheroad_juice <- 
    recipe(track_name ~
               danceability +
               energy +
               loudness +
               speechiness +
               acousticness +
               instrumentalness +
               liveness +
               valence +
               tempo +
               duration_ms +
               C + `C#|Db` + D + `D#|Eb` +
               E + `F` + `F#|Gb` + G +
               `G#|Ab` + A + `A#|Bb` + B +
               c01 + c02 + c03 + c04 + c05 + c06 +
               c07 + c08 + c09 + c10 + c11 + c12,
           data = OntheRoad12) %>% 
    step_center(all_predictors()) %>%
    step_scale(all_predictors()) %>%
    # step_range(all_predictors()) %>% 
    prep(OntheRoad12 %>% mutate(track_name = str_trunc(track_name, 20))) %>% 
    juice %>% 
    column_to_rownames('track_name')
```

```{r}
Coffeehouse_dist <- dist(Coffeehouse_juice, method = 'euclidean')

Ontheroad_dist <- dist(Ontheroad_juice, method = 'euclidean')
```

### Coffeehouse
```{r}
protoclust(Coffeehouse_dist) %>% dendro_data %>% ggdendrogram
```

### On the Road
```{r}
protoclust(Ontheroad_dist) %>% dendro_data %>% ggdendrogram
```

Sidebar {.sidebar}
------------------------------------------------------

### Dendrograms

I might still change these, since they are really unclear.

Heatmaps {.tabset}
=====================================================

Row
--------------------------------------------------
```{r eval = FALSE}
kmeans(Coffeehouse_juice, 4)

kmeans(Ontheroad_juice, 4)
```


### Coffeehouse

```{r}
grDevices::dev.size("px")
heatmaply(
    Coffeehouse_juice,
    hclustfun = hclust,
    # hclustfun = protoclust,
    # Comment out the hclust_method line when using protoclust.
    hclust_method = 'average',
    dist_method = 'euclidean')
```

### On the Road

```{r}
grDevices::dev.size("px")
heatmaply(
    Ontheroad_juice,
    hclustfun = hclust,
    # hclustfun = protoclust,
    # Comment out the hclust_method line when using protoclust.
    hclust_method = 'average',
    dist_method = 'euclidean')
```

Sidebar {.sidebar}
-------------------------------------------------

### Heatmaps

